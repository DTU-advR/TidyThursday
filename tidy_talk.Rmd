---
title: "Tidy Talk"
subtitle: "DTU Bioinformatics"
author: "Leon Eyrich Jessen, PhD"
date: "February 9th 2018"
output: ioslides_presentation
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library('tidyverse')
library('broom')
set.seed(773118)
```

# Introduction

## What is tidyverse?

![http://tidyverse.org](figures/tidyverse_web.png)

## What is tidy data?

You spend your time getting the data into a specific format 'tidy data':

 - Each column is `one` variable
 - Each row is `one` observation
 - Each cell is `one` value

...and then you can apply the plethora of tidy tools!

## Why is tidyverse?

Base

```{r base, echo=TRUE, eval=FALSE}
median(sort(round(sample(rnorm(100,mean=2),10),3)))
```

Tidy

```{r tidy, echo=TRUE, eval=FALSE}
100 %>% rnorm(mean=2) %>% sample(10) %>% round(3) %>% sort %>% median
```

 - Same result, but...
 - From virtually unreadable to self explanatory
 - _"Programs must be written for people to read, and only incidentally for machines to execute"_ [Abelson, H., Sussman, G.J. & Sussman, J.  __Structure and Interpretation of Computer Programs__, 1996]

## The pipe ` %>% `

 - Familiar to anyone used to using *nix systems
 - Simple, yet extremely powerful
 - The pipe separates two function feeding the output from the left hand function in as input to the right hand function

```{r the_pipe, echo=TRUE, eval=FALSE}
100 %>% rnorm(mean=2) %>% sample(10) %>% round(3) %>% sort %>% median
```

```{r the_pipe_details, echo=TRUE, eval=TRUE}
input  = 100;
output = rnorm(input,mean=2); input = output
output = sample(input,10);    input = output
output = round(input,3);      input = output
output = sort(input);         input = output
output = median(input)
output
```
## Data structures

The matrix can only hold one data type, e.g. numerical
```{r base_matrix, echo=TRUE}
matrix(1:8, nrow = 2, byrow = TRUE)
```

The data frame can mix data types
```{r base_df, echo=TRUE}
(d = data.frame(x_var = 1:2, y_var = c('a','b')))
```

## Data structures

Problem `x_var` and  `y_var` can be accessed using `x` and `y`
```{r base_df_problem, echo=TRUE}
d$x
d$y
```

 - Short hand variable names
 - StringsAsFactors

# Let's be tidy

## Introducing the `tibble()`

Same data as before - but, now we no longer have a problem
```{r set_tibble_dat, echo=TRUE}
d = tibble(x_var = 1:2, y_var = c('a','b'))
```

```{r tibble_no_problem, echo=TRUE}
d$x
d$y
```

## Reading files

 - `read.table()` is now `read_table()`
 - `read.delim()` is now `read_delim()`
 - `read.delim(sep = "\t")` is now `read_tsv()`
 - `read.csv()` is now `read_csv()`
 - Etc.
 
No need to use `fread()` the `tidyverse` read file functions are fast!

Also note we do not use one function with different delimiters, we use different functions for each file type!

## Read a file from the web

Define the location of the file

```{r set_file, echo=TRUE}
my_git = 'https://raw.githubusercontent.com/leonjessen/'
pep_file = my_git %>%
  paste0('keras_tensorflow_demo/master/data/',
         'ran_peps_netMHCpan40_predicted_A0201_',
         'reduced_cleaned_balanced.tsv')
```

## Read a file from the web

Read the file
```{r read_from_web, echo=TRUE}
pep_dat = pep_file %>% read_tsv
```

## Read a file from the web

See the file content, which is now a tibble
```{r see_file_from_web, echo=TRUE}
pep_dat
```

## Summarise data
```{r summarise_data, echo=TRUE}
pep_dat %>% group_by(label_chr, data_type) %>% summarise(n = n())
```

## Visualise data
```{r visualise_summary_cmd, echo=TRUE, eval=FALSE}
pep_dat %>% group_by(label_chr, data_type) %>% summarise(n = n()) %>%
  ggplot(aes(x = data_type, y = n)) +
  geom_bar(stat="identity") +
  facet_wrap(~label_chr) +
  theme_bw()
```

## Visualise data
```{r visualise_summary_plot, echo=FALSE, eval=TRUE}
pep_dat %>% group_by(label_chr, data_type) %>% summarise(n = n()) %>%
  ggplot(aes(x = data_type, y = n)) +
  geom_bar(stat="identity") +
  facet_wrap(~label_chr) +
  theme_bw()
```

# Basic `tibble` operations

## Filter rows

```{r filter_rows, echo=TRUE}
pep_dat %>% filter(label_chr == 'SB')
```

## Filter columns

```{r filter_columns, echo=TRUE}
pep_dat %>% select(peptide,label_chr,label_num)
```

## Remove rows containing NA
```{r remove_na, echo=TRUE}
pep_dat %>% filter(complete.cases(.))
```

## Create new variables
```{r new_vars, echo=TRUE}
pep_dat %>% mutate(kmer = peptide %>% str_sub(start = 1, end = 3))
```

## Rename variables
```{r rename_vars, echo=TRUE}
pep_dat %>% rename(partition = data_type)
```

## Get vector from tibble
```{r get_vetor, echo=TRUE}
pep_dat %>% pull(peptide) %>% head(3)
```

## Wide to long format

```{r mk_tibble, echo=TRUE}
(m_wide = tibble(ID = paste0("s",1:3), v1 = rnorm(3),
           v2 = rnorm(3), v3 = rnorm(3)))
```

## Wide to long format

```{r wide_to_long, echo=TRUE}
(m_long = m_wide %>% gather(key = var, value = value, -ID))
```

## Long to wide format

```{r long_to_wide, echo=TRUE}
m_long %>% spread(key = var, value = value)
```

# Up the game...

## Pipeline for grouped models

We will be using `iris`

```{r see_iris, echo=TRUE}
iris %>% as_tibble %>% group_by(Species) %>%
  summarise(n=n(),mu1=mean(Sepal.Length),mu2=mean(Sepal.Width),
            mu3=mean(Petal.Length),mu4=mean(Petal.Width))
```

## Pipeline for grouped models

Model the `Sepal.Length` as a function of `Sepal.Width`, but stratified on `Species` including confidence intervals and number of data points:

```{r grouped_models, echo=TRUE}
iris %>% as_tibble %>% group_by(Species) %>% 
  do(model = lm(Sepal.Length ~ Sepal.Width, data = .) %>%
       tidy %>% slice(2),
     ci = lm(Sepal.Length ~ Sepal.Width, data = .) %>%
       confint %>% tidy %>% slice(2),
     n = nrow(.)) %>% unnest(model, ci, n) %>%
  select(-.rownames,-term) %>% mutate_if(is.numeric,funs(round(.,3)))
```

## Hungry for more?

![http://r4ds.had.co.nz/](figures/r4ds.png)

# Final Remarks

## In conclusion

 - Tidyverse is written in C++
 - Tidyverse reduces long pipelines, like you would with a long equation
 - Tidyverse is fast (Case-dependent, but comparable to Python)
 - Tidyverse is super nice to work with
 - and yes I made this presention in R
 - OMG you can make presentations in R???
 - Yes you can and you can even do real math: $E(x) = \frac{1}{n} \cdot \sum_{i=1}^{n} x_i$
 
# Questions and comments?
